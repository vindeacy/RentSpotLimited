generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(uuid())
  role         String
  email        String    @unique
  passwordHash String
  name         String?
  phone        String?
  isActive     Boolean   @default(true)
  isVerified   Boolean   @default(false) 
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  landlord     Landlord?
  messagesFrom Message[] @relation("fromUser")
  messagesTo   Message[] @relation("toUser")
  tenant       Tenant?
}

model Landlord {
  id          String     @id @default(uuid())
  userId      String     @unique
  companyName String?
  verified    Boolean    @default(false)
  createdAt   DateTime   @default(now())
  businessLicense String?
  taxId          String?
  website        String?
  description    String?
  rating         Float?     @default(0)
  totalRatings   Int?       @default(0)
  documentsUrl   String[]   @default([])
  address        String?
  city           String?
  state          String?
  postalCode     String?
  kraPin         String?   // KRA PIN for tax compliance
  kraVerified    Boolean   @default(false)
  bankDetails    Json?     // Bank account for payments
  user        User       @relation(fields: [userId], references: [id])
  leases      Lease[]
  properties  Property[]
  maintenanceRequests MaintenanceRequest[]
  notifications       Notification[]
  taxReturns          TaxReturn[]
  invoices            Invoice[]
  reviews             Review[]
}

model Tenant {
  id                       String    @id @default(uuid())
  userId                   String    @unique
   employmentStatus         String?   
  rating                   Int       @default(0)
  dob                      DateTime?
  idDocUrl                 String?
  createdAt                DateTime  @default(now())
  leaseId                  String?
  verified                 Boolean   @default(false)
  bankAccountInfo          Json?
  currentPropertyId        String?
  documentsUploaded        Boolean   @default(false)
  emergencyContactEmail    String?
  emergencyContactName     String?
  emergencyContactPhone    String?
  emergencyContactRelation String?
  maxRent                  Float?
  moveInDate               DateTime?
  petOwner                 Boolean   @default(false)
  preferredAreas           String[]  @default([])
  preferredPaymentMethod   String?
  previousAddress          String?
  profileCompleted         Boolean   @default(false)
  smokingStatus            String?   @default("non-smoker")
  kraPin                   String?  
  employerPin              String?   
  leases                   Lease[]
  payments                 Payment[]
  maintenanceRequests      MaintenanceRequest[]
  notifications            Notification[]
  reviews                  Review[]
  currentProperty          Property? @relation(fields: [currentPropertyId], references: [id])
  user                     User      @relation(fields: [userId], references: [id])
}

model Payment {
  id            String    @id @default(uuid())
  tenantId      String
  leaseId       String
  amount        Float
  dueDate       DateTime
  paidDate      DateTime?
  paymentMethod String?
  status        String    @default("pending")
  reference     String?
  notes         String?
  withholdingTax Float?    @default(0)  
  vatAmount      Float?    @default(0)  
  netAmount      Float?                 
  kraReported    Boolean   @default(false)
  kraReceiptNo   String?               
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lease         Lease     @relation(fields: [leaseId], references: [id])
  tenant        Tenant    @relation(fields: [tenantId], references: [id])
  invoice       Invoice?
}

model Property {
  id             String          @id @default(uuid())
  landlordId     String
  title          String
  slug           String          @unique
  description    String?
  addressLine    String?
  city           String?
  state          String?
  postalCode     String?
  country        String?
  latitude       Float?
  longitude      Float?
  price          Float
  currency       String?
  deposit        Float?
  availableFrom  DateTime?
  propertyType   String?
  bedrooms       Int?
  bathrooms      Int?
  size           Int?
  amenities      String[]        @default([])
  status         String          @default("vacant")
  seoTitle       String?
  seoDescription String?
  viewCount         Int             @default(0)
  totalInquiries    Int             @default(0)
  lastMaintenance   DateTime?
  nextInspection    DateTime?
  insuranceExpiry   DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  applications   Application[]
  leases         Lease[]
  messages       Message[]
  landlord       Landlord        @relation(fields: [landlordId], references: [id])
  images         PropertyImage[]
  tenants        Tenant[]
  maintenanceRequests MaintenanceRequest[]
  expenses            Expense[]
  reviews             Review[]
}

model PropertyImage {
  id         String   @id @default(uuid())
  propertyId String
  url        String
  alt        String?
  position   Int      @default(0)
  property   Property @relation(fields: [propertyId], references: [id])
}

model Application {
  id             String   @id @default(uuid())
  propertyId     String
  tenantUserId   String?
  applicantName  String?
  applicantEmail String?
  applicantPhone String?
  currentAddress String?
  employment     Json?
  references     Json?
  creditScore    Int?
  monthlyIncome  Float?
  moveInDate     DateTime?
  docs           Json?
  status         String   @default("new")
  score          Float?
  landlordNotes  String?
  rejectionReason String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  property       Property @relation(fields: [propertyId], references: [id])
}

model Lease {
  id         String    @id @default(uuid())
  propertyId String
  tenantId   String?
  landlordId String
  startDate  DateTime?
  endDate    DateTime?
  rent       Float?
  status     String    @default("pending")
  deposit           Float?
  securityDeposit   Float?
  leaseTermMonths   Int?
  renewalOption     Boolean   @default(false)
  renewalNoticeDate DateTime?
  renewalTerms      Json?
  earlyTermination  Boolean   @default(false)
  lateFeeAmount     Float?
  lateFeeGracePeriod Int?     @default(5)
  petDeposit        Float?
  utilities         String[]  @default([])
  restrictions      String[]  @default([])
  specialTerms      String?
  signedDate        DateTime?
  terminationDate   DateTime?
  terminationReason String?
  createdAt  DateTime  @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  landlord   Landlord  @relation(fields: [landlordId], references: [id])
  property   Property  @relation(fields: [propertyId], references: [id])
  tenant     Tenant?   @relation(fields: [tenantId], references: [id])
  payments   Payment[]
}

model Message {
  id         String    @id @default(uuid())
  fromUserId String?
  toUserId   String?
  propertyId String?
  subject    String?
  body       String?
  read       Boolean   @default(false)
  createdAt  DateTime  @default(now())
  fromUser   User?     @relation("fromUser", fields: [fromUserId], references: [id])
  property   Property? @relation(fields: [propertyId], references: [id])
  toUser     User?     @relation("toUser", fields: [toUserId], references: [id])
}

model MaintenanceRequest {
  id          String   @id @default(uuid())
  propertyId  String
  tenantId    String?
  landlordId  String
  title       String
  description String
  priority    String   @default("medium") // low, medium, high, urgent
  category    String?  // plumbing, electrical, hvac, etc.
  status      String   @default("open")   // open, in_progress, completed, cancelled
  images      String[] @default([])
  cost        Float?
  assignedTo  String?  // contractor/maintenance person
  scheduledDate DateTime?
  completedDate DateTime?
  landlordNotes String?
  tenantRating  Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  property    Property @relation(fields: [propertyId], references: [id])
  tenant      Tenant?  @relation(fields: [tenantId], references: [id])
  landlord    Landlord @relation(fields: [landlordId], references: [id])
}

model Notification {
  id         String   @id @default(uuid())
  userId     String?  // Can be for any user type
  landlordId String?
  tenantId   String?
  title      String
  message    String
  type       String   // payment_due, lease_expiring, maintenance_request, etc.
  read       Boolean  @default(false)
  actionUrl  String?
  metadata   Json?
  createdAt  DateTime @default(now())
  landlord   Landlord? @relation(fields: [landlordId], references: [id])
  tenant     Tenant?   @relation(fields: [tenantId], references: [id])
}

model Review {
  id              String   @id @default(uuid())
  tenantId        String
  propertyId      String
  landlordId      String
  rating          Int
  title           String?
  comment         String
  category        String?
  pros            String?
  cons            String?
  wouldRecommend  Boolean  @default(true)
  isPublic        Boolean  @default(true)
  isVerified      Boolean  @default(false)
  response        String?
  responseDate    DateTime?
  helpfulCount    Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  property        Property @relation(fields: [propertyId], references: [id])
  landlord        Landlord @relation(fields: [landlordId], references: [id])

  @@unique([tenantId, propertyId])
  @@index([landlordId])
  @@index([propertyId])
  @@index([tenantId])
}

model TaxReturn {
  id              String   @id @default(uuid())
  landlordId      String
  year            Int
  quarter         Int?     // Q1, Q2, Q3, Q4
  period          String   // e.g., "2024-Q1" or "2024"
  totalRentalIncome Float
  totalExpenses   Float
  taxableIncome   Float
  taxAmount       Float
  withholdingTax  Float    @default(0)
  status          String   @default("pending") // pending, filed, approved
  filedDate       DateTime?
  kraReference    String?  // KRA filing reference
  metadata        Json?    // Additional tax details
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  landlord        Landlord @relation(fields: [landlordId], references: [id])
  
  @@unique([landlordId, year, quarter])
}

model Invoice {
  id              String   @id @default(uuid())
  landlordId      String
  paymentId       String   @unique
  invoiceNumber   String   @unique
  invoiceDate     DateTime @default(now())
  dueDate         DateTime
  amount          Float
  tax             Float    @default(0)
  totalAmount     Float
  status          String   @default("pending") // pending, paid, overdue, cancelled
  etimsReference  String?  // eTIMS system reference
  qrCode          String?  // QR code for verification
  pdfUrl          String?  // Invoice PDF storage
  sentToKRA       Boolean  @default(false)
  kraAcknowledged Boolean  @default(false)
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  landlord        Landlord @relation(fields: [landlordId], references: [id])
  payment         Payment  @relation(fields: [paymentId], references: [id])
}

model Expense {
  id              String   @id @default(uuid())
  landlordId      String?
  propertyId      String?
  category        String   // maintenance, utilities, insurance, etc.
  description     String
  amount          Float
  expenseDate     DateTime
  receiptUrl      String?
  vendor          String?
  deductible      Boolean  @default(true)
  kraReported     Boolean  @default(false)
  taxYear         Int?
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  property        Property? @relation(fields: [propertyId], references: [id])
}
